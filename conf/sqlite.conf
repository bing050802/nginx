user  root;
worker_processes 1;
daemon off;
error_log stderr info;

pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
	lua_code_cache off;
	lua_package_path '/home/github/tengcdn/lualib/?.lua;;';
	lua_package_cpath '/home/github/tengcdn/lualib/?.so;;';
    lua_shared_dict itesty_limit 100k;
    lua_shared_dict ip_blacklist 10m;
    lua_shared_dict ip_whitelist 10m;
    lua_shared_dict req_metrics 10m;	
    lua_shared_dict req_iplist 10m;
    
    lua_shared_dict wsettings 10m;
    lua_shared_dict upstream_cached 10m;
    lua_shared_dict upstreams 10m;
    
    lua_shared_rbtree settings 10m;
    lua_shared_dict locked 100k;
    
    init_by_lua_block {
		local config = require "cdn.config"
		config:set("log.status", true)
		config:set("log.level", 1)
		
		local logger = require "resty.logger"
		local log = logger:open("/tmp/cdn.log")
		log:set_level(0)
		config:set("log.file", log)
		config:set("db.file", "/home/millken/rqlite/node.2/db.sqlite3")
    }
    	
    init_worker_by_lua_block {
    	local worker = require "cdn.worker"
    	worker:start({
        	interval = 3,
    	})
    }
        	    
	access_by_lua_block {
		require "cdn.access"
	}
    
    server {
        listen 82;
        location / {
            return 200 "82";
        }
    }
        
    server {
        listen 81;
        location @dyup_init {
        	dyups_interface;
    	}
    	
        location / {

			content_by_lua_block {
				ngx.say("81")
			}
        }
        
        location /test {
			content_by_lua_block {
				local test = require "cdn.test"
				test.version()
				ngx.say("done")
			} 
        }

    }
}
